/*! openvod | emma | ISC */
"use strict";!function(){angular.module("app.controllers",[]).controller("indexController",["$scope",function(a){this.init=function(){this.maskUrl=""}}]).controller("loginController",["$scope","$http","$state","$filter","md5","util",function(a,b,c,d,e,f){console.log("loginController");var g=this;g.init=function(){},g.login=function(){g.loading=!0;var a=JSON.stringify({username:g.userName,password:e.createHash(g.password)});b({method:"POST",url:f.getApiUrl("logon","","server"),data:a}).then(function(a){var b=a.data;"200"==b.rescode?(f.setParams("token",b.token),g.getEditLangs()):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){g.loading=!1})},g.getEditLangs=function(){b({method:"GET",url:f.getApiUrl("","editLangs.json","local")}).then(function(a){f.setParams("editLangs",a.data.editLangs),c.go("app")},function(a){})}}]).controller("appController",["$http","$scope","$state","$stateParams","util","CONFIG",function(a,b,c,d,e,f){function g(){this.data=[],this.maxId=0}var h=this;h.init=function(){h.uploadListUrl="",h.showUploadList=!1,h.gotoPage("uploadList"),h.maskUrl="",h.maskParams={},h.uploadList=new g},h.gotoPage=function(a){"uploadList"==a?(""!==h.uploadListUrl||(h.uploadListUrl="pages/uploadList.html"),h.showUploadList=!0):(h.showUploadList=!1,c.go(a))},h.logout=function(a){e.setParams("token",""),c.go("login")},h.upload=function(){h.maskUrl="pages/addMovie.html"},g.prototype={add:function(a,b){return this.data.push({video:a,subtitle:b,id:this.maxId}),this.maxId++},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].video.percentComplete<100&&"失败"!=b[c].video.percentComplete&&b[c].video.xhr.abort(),void 0!=b[c].subtitle.percentComplete&&b[c].subtitle.percentComplete<100&&"失败"!=b[c].subtitle.percentComplete&&b[c].subtitle.xhr.abort(),b.splice(c,1);break}},judgeCompleted:function(a,b){for(var c=this.data,d=0;d<c.length;d++)if(c[d].id==a){(c[d].video.percentComplete>=100&&void 0==c[d].subtitle.percentComplete||c[d].video.percentComplete>=100&&c[d].subtitle.percentComplete>=100)&&b.transcode(a,b);break}},transcode:function(b,d){for(var d=d,b=b,f=this.data,g={},h=0;h<f.length;h++)if(f[h].id==b){g=f[h];break}var i=JSON.stringify({action:"submitTranscodeTask",token:e.getParams("token"),rescode:"200",data:{movie:{oriFileName:g.video.name,filePath:g.video.src},subtitle:{oriFileName:g.subtitle.name,filePath:g.subtitle.src}}});console&&console.log(i),a({method:"POST",url:e.getApiUrl("tanscodetask","","server"),data:i}).then(function(a){var e=a.data;"200"==e.rescode?(console&&console.log("转码 "+b),d.deleteById(b)):"401"==e.rescode?(alert("访问超时，请重新登录"),c.go("login")):(console&&console.log("转码申请失败后再次调用"),setTimeout(function(){d.transcode(b,d)},5e3))},function(a){console&&console.log("转码申请失败后再次调用"),console&&console.log(a),setTimeout(function(){d.transcode(b,d)},5e3)})},uploadFile:function(a,c,d){var g=f.uploadVideoUrl,h=new XMLHttpRequest,i={name:a.name,size:a.size,percentComplete:0,xhr:h},j={};if(c){var k=new XMLHttpRequest;j={name:c.name,size:c.size,percentComplete:0,xhr:k}}var l=this.add(i,j);e.uploadFileToUrl(h,a,g,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);d.setPercentById("video",l,b)}})},function(a){var c=JSON.parse(a.responseText);console&&console.log(c),b.$apply(function(){d.setSrcSizeById("video",l,c.filePath,c.size),d.judgeCompleted(l,d)})},function(a){b.$apply(function(){d.setPercentById("video",l,"失败")}),a.abort()}),void 0!=j.percentComplete&&e.uploadFileToUrl(j.xhr,c,g,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);d.setPercentById("subtitle",l,b)}})},function(a){var c=JSON.parse(a.responseText);console&&console.log(c),b.$apply(function(){d.setSrcSizeById("subtitle",l,c.filePath,c.size),d.judgeCompleted(l,d)})},function(a){b.$apply(function(){d.setPercentById("subtitle",l,"失败")}),a.abort()})}}}]).controller("transcodingListController",["$http","$scope","$state","$stateParams","util",function(a,b,c,d,e){console.log("transcodingListController");var f=this;f.init=function(){b.app.showUploadList=!1,f.getTranscodeTaskList()},f.getTranscodeTaskList=function(){f.loading=!0;var b=JSON.stringify({token:e.getParams("token"),action:"getTranscodeTaskList",status:"working"});a({method:"POST",url:e.getApiUrl("tanscodetask","","server"),data:b}).then(function(a){var b=a.data;if("200"==b.rescode){if(0==b.data.taskList.length)return void(f.noData=!0);f.taskList=b.data.taskList}else"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){f.loading=!1})},f.refresh=function(){c.reload("app.transcodingList")}}]).controller("notEditedListController",["$http","$scope","$state","$stateParams","util",function(a,b,c,d,e){console.log("notEditedListController");var f=this;f.init=function(){b.app.showUploadList=!1,f.getTranscodeTaskList()},f.add=function(a){b.app.maskUrl="pages/addMovieInfo.html",b.app.maskParams=a},f.getTranscodeTaskList=function(){f.loading=!0;var b=JSON.stringify({token:e.getParams("token"),action:"getTranscodeTaskList",status:"Completed"});a({method:"POST",url:e.getApiUrl("tanscodetask","","server"),data:b}).then(function(a){var b=a.data;if("200"==b.rescode){if(0==b.data.taskList.length)return void(f.noData=!0);f.taskList=b.data.taskList}else"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){f.loading=!1})},f.delMovie=function(b){if(confirm("确定删除？")){var d=JSON.stringify({token:e.getParams("token"),action:"delTranscodeTask",lang:"zh-CN",taskID:b});a({method:"POST",url:e.getApiUrl("movie","","server"),data:d}).then(function(a){var b=a.data;"200"==b.rescode?(alert("删除成功"),c.reload(c.current.name)):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){})}}}]).controller("editedListController",["$http","$scope","$state","$filter","$stateParams","NgTableParams","util",function(a,b,c,d,e,f,g){console.log("editedListController");var h=this;h.init=function(){b.arr={},b.arr.catrgoryArr=[],b.arr.LocationArr=[],h.defaultLang=g.getDefaultLangCode(),h.getTags()},h.edit=function(a){b.app.maskUrl="pages/editMovieInfo.html",b.app.maskParams={movieID:a}},h.getTags=function(){var b=JSON.stringify({token:g.getParams("token"),action:"getTags"});a({method:"POST",url:g.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(0==b.CategoryList.length?h.noCategotyData=!0:h.categoryList=b.CategoryList,0==b.LocationList.length?h.noLocationData=!0:h.locationList=b.LocationList):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.loading=!1})},h.chooseCateory=function(a,c){if(1==c)b.arr.catrgoryArr.push(a);else{var d=b.arr.catrgoryArr.indexOf(a);b.arr.catrgoryArr.splice(d,1)}},h.chooseLocation=function(a,c){if(1==c)b.arr.LocationArr.push(a);else{var d=b.arr.LocationArr.indexOf(a);b.arr.LocationArr.splice(d,1)}},b.$watch("arr",function(a){h.getMovieList()},!0),h.getMovieList=function(){h.loading=!0,h.noData=!1,h.tableParams=new f({page:1,count:15,url:""},{counts:[],getData:function(c){var e={action:"getMovieList",token:g.getParams("token"),keywords:h.keywords,locationID:b.arr.LocationArr,categoryID:b.arr.catrgoryArr},f=c.url();return e.per_page=f.count-0,e.page=f.page-0,e=JSON.stringify(e),a({method:d("ajaxMethod")(),url:g.getApiUrl("movie","shopList","server"),data:e}).then(function(a,b,d,e){return 0==a.data.total&&(h.noData=!0),c.total(a.data.total),a.data.movieList},function(a,b,c,d){alert(response.status+" 服务器出错")}).finally(function(a){h.loading=!1})}})},h.addMoreMovie=function(){b.app.maskUrl="pages/addMoreMovie.html"},h.delMovie=function(b){if(confirm("确定删除？")){var d=JSON.stringify({token:g.getParams("token"),action:"delMovie",lang:"zh-CN",movieID:b});a({method:"POST",url:g.getApiUrl("movie","","server"),data:d}).then(function(a){var b=a.data;"200"==b.rescode?(alert("删除成功"),c.reload(c.current.name)):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){})}}}]).controller("addMovieController",["$http","$scope","$state","$stateParams","util",function(a,b,c,d,e){console.log("addMovieController");var f=this;f.init=function(){},f.cancel=function(){b.app.maskUrl=""},f.add=function(){b.app.uploadList.uploadFile(b.myFileMovie,b.myFileSubtitle,b.app.uploadList),b.app.maskUrl=""}}]).controller("addMovieInfoController",["$http","$scope","$state","$stateParams","util","CONFIG",function(a,b,c,d,e,f){function g(){this.data=[],this.maxId=0}console.log("addMovieInfoController");var h=this;h.init=function(){h.editLangs=e.getParams("editLangs"),h.defaultLang=e.getDefaultLangCode(),h.maskParams=b.app.maskParams,h.catrgoryArr=[],h.LocationArr=[],h.movieInfo={},h.uploadList=new g,h.getTags()},h.cancel=function(){b.app.maskUrl=""},h.addCoverImg=function(){h.uploadList.uploadFile(b.myCoverImg,h.uploadList)},g.prototype={add:function(a){return this.data.push({img:a,id:this.maxId}),this.maxId},changeImg:function(a){return this.data=[],this.data.push({img:a,id:this.maxId}),this.maxId},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].img.percentComplete<100&&"失败"!=b[c].img.percentComplete&&b[c].video.xhr.abort(),b.splice(c,1);break}},uploadFile:function(a,c){var d=f.uploadImgUrl,g=new XMLHttpRequest,i={name:a.name,size:a.size,percentComplete:0,xhr:g},j=this.changeImg(i);e.uploadFileToUrl(g,a,d,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);c.setPercentById("img",j,b)}})},function(a){var d=JSON.parse(a.responseText);console&&console.log(d),b.$apply(function(){c.setSrcSizeById("img",j,d.upload_path,d.size)}),h.movieInfo.PicSize=d.size,alert("图片上传成功")},function(a){alert("图片上传失败，请重新上传"),c.deleteById(j),a.abort()})}},h.getTags=function(){var b=JSON.stringify({token:e.getParams("token"),action:"getTags"});a({method:"POST",url:e.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(0==b.CategoryList.length?h.noCategotyData=!0:h.categoryList=b.CategoryList,0==b.LocationList.length?h.noLocationData=!0:h.locationList=b.LocationList):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.loading=!1})},h.chooseCateory=function(a,b){if(1==b)h.catrgoryArr.push(a);else{var c=h.catrgoryArr.indexOf(a);h.catrgoryArr.splice(c,1)}},h.chooseLocation=function(a,b){if(1==b)h.LocationArr.push(a);else{var c=h.LocationArr.indexOf(a);h.LocationArr.splice(c,1)}},h.addMovie=function(){if(0==h.catrgoryArr.length)return void alert("请选择类型");if(0==h.LocationArr.length)return void alert("请选择产地");if(0==h.uploadList.data.length)return void alert("请上传图片");h.saving=!0;var b=JSON.stringify({token:e.getParams("token"),action:"addMovie",lang:"zh-CN",taskID:h.maskParams.ID,Movie:{Seq:h.movieInfo.Seq,PicSize:h.movieInfo.PicSize-0,Name:h.movieInfo.Name,Actor:h.movieInfo.Actor,Director:h.movieInfo.Director,URL_ABS:h.maskParams.URL,MovieSize:h.maskParams.Size,Duration:h.maskParams.Duration,Score:h.movieInfo.Score,SearchName:h.movieInfo.SearchName,Year:h.movieInfo.Year,Price:h.movieInfo.Price,Introduce:h.movieInfo.Introduce,PicURL_ABS:h.uploadList.data[0].img.src},Category:h.catrgoryArr,Location:h.LocationArr});a({method:"POST",url:e.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(alert("添加成功"),h.cancel(),c.reload("app.notEditedList")):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.saving=!1,h.cancel()})}}]).controller("addMoreMovieController",["$http","$scope","$state","$stateParams","util","CONFIG",function(a,b,c,d,e,f){function g(){this.data=[],this.maxId=0}console.log("addMoreMovieController");var h=this;h.init=function(){h.editLangs=e.getParams("editLangs"),h.defaultLang=e.getDefaultLangCode(),h.catrgoryArr=[],h.LocationArr=[],h.movieInfo={},h.uploadList=new g,h.getTags()},h.cancel=function(){b.app.maskUrl=""},h.addCoverImg=function(){h.uploadList.uploadFile(b.myCoverImg,h.uploadList)},g.prototype={add:function(a){return this.data.push({img:a,id:this.maxId}),this.maxId},changeImg:function(a){return this.data=[],this.data.push({img:a,id:this.maxId}),this.maxId},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].img.percentComplete<100&&"失败"!=b[c].img.percentComplete&&b[c].video.xhr.abort(),b.splice(c,1);break}},uploadFile:function(a,c){var d=f.uploadImgUrl,g=new XMLHttpRequest,i={name:a.name,size:a.size,percentComplete:0,xhr:g},j=this.changeImg(i);e.uploadFileToUrl(g,a,d,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);c.setPercentById("img",j,b)}})},function(a){var d=JSON.parse(a.responseText);console&&console.log(d),b.$apply(function(){c.setSrcSizeById("img",j,d.upload_path,d.size)}),h.movieInfo.PicSize=d.size,alert("图片上传成功")},function(a){alert("图片上传失败，请重新上传"),c.deleteById(j),a.abort()})}},h.getTags=function(){var b=JSON.stringify({token:e.getParams("token"),action:"getTags"});a({method:"POST",url:e.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(0==b.CategoryList.length?h.noCategotyData=!0:h.categoryList=b.CategoryList,0==b.LocationList.length?h.noLocationData=!0:h.locationList=b.LocationList):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.loading=!1})},h.chooseCateory=function(a,b){if(1==b)h.catrgoryArr.push(a);else{var c=h.catrgoryArr.indexOf(a);h.catrgoryArr.splice(c,1)}},h.chooseLocation=function(a,b){if(1==b)h.LocationArr.push(a);else{var c=h.LocationArr.indexOf(a);h.LocationArr.splice(c,1)}},h.addMovie=function(){if(0==h.catrgoryArr.length)return void alert("请选择类型");if(0==h.LocationArr.length)return void alert("请选择产地");if(0==h.uploadList.data.length)return void alert("请上传图片");h.saving=!0;var b=JSON.stringify({token:e.getParams("token"),action:"addMovie",lang:"zh-CN",Movie:{Seq:h.movieInfo.Seq,PicSize:h.uploadList.data[0].img.size,Name:h.movieInfo.Name,Actor:h.movieInfo.Actor,Director:h.movieInfo.Director,URL_ABS:h.movieInfo.URL_ABS,MovieSize:h.movieInfo.MovieSize,Duration:h.movieInfo.Duration,Score:h.movieInfo.Score,SearchName:h.movieInfo.SearchName,Year:h.movieInfo.Year,Price:h.movieInfo.Price,Introduce:h.movieInfo.Introduce,PicURL_ABS:h.uploadList.data[0].img.src},Category:h.catrgoryArr,Location:h.LocationArr});a({method:"POST",url:e.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(alert("添加成功"),h.cancel(),c.reload("app.notEditedList")):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.saving=!1,h.cancel()})}}]).controller("editMovieInfoController",["$http","$scope","$state","$filter","$stateParams","util","CONFIG",function(a,b,c,d,e,f,g){function h(){this.data=[],this.maxId=0}console.log("editMovieInfoController");var i=this;i.init=function(){i.editLangs=f.getParams("editLangs"),i.defaultLang=f.getDefaultLangCode(),i.maskParams=b.app.maskParams,i.catrgoryArr=[],i.LocationArr=[],i.movieInfo={},i.uploadList=new h,i.getMovieInfo()},i.cancel=function(){b.app.maskUrl=""},i.addCoverImg=function(){i.uploadList.uploadFile(b.myCoverImg,i.uploadList)},h.prototype={add:function(a){return this.data.push({img:a,id:this.maxId}),this.maxId},changeImg:function(a){return this.data=[],this.data.push({img:a,id:this.maxId}),this.maxId},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].img.percentComplete<100&&"失败"!=b[c].img.percentComplete&&b[c].video.xhr.abort(),b.splice(c,1);break}},uploadFile:function(a,c){var d=g.uploadImgUrl,e=new XMLHttpRequest,h={name:a.name,size:a.size,percentComplete:0,xhr:e},i=this.changeImg(h);f.uploadFileToUrl(e,a,d,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);c.setPercentById("img",i,b)}})},function(a){var d=JSON.parse(a.responseText);console&&console.log(d),b.$apply(function(){c.setSrcSizeById("img",i,d.upload_path,d.size)}),alert("图片上传成功")},function(a){alert("图片上传失败，请重新上传"),c.deleteById(i),a.abort()})}},i.getMovieInfo=function(){i.loading=!0;var b=JSON.stringify({token:f.getParams("token"),action:"getMovieInfoByID",movieID:i.maskParams.movieID});a({method:"POST",url:f.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;if("200"==b.rescode){i.movieInfo=b;var d={};d.img={},d.img.src=i.movieInfo.PicURL_ABS,d.img.size=i.movieInfo.PicSize,i.uploadList.data=[d],i.maskParams.URL_ABS=b.URL_ABS,i.maskParams.Duration=b.Duration}else"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){i.loading=!1})},i.chooseCateory=function(a,b){if(1==b)i.catrgoryArr.push(a);else{var c=i.catrgoryArr.indexOf(a);i.catrgoryArr.splice(c,1)}},i.chooseLocation=function(a,b){if(1==b)i.LocationArr.push(a);else{var c=i.LocationArr.indexOf(a);i.LocationArr.splice(c,1)}},i.checkCategory=function(a,b){for(var c=0;c<b.length;c++)if(b[c]==a)return i.chooseCateory(a,!0),!0},i.checkLocation=function(a,b){for(var c=0;c<b.length;c++)if(b[c]==a)return i.chooseLocation(a,!0),!0},i.editMovieInfo=function(){i.saving=!0;var b=JSON.stringify({token:f.getParams("token"),action:"addMovie",lang:"zh-CN",movieID:i.maskParams.movieID,Movie:{Seq:i.movieInfo.Seq,Name:i.movieInfo.Name,PicSize:i.uploadList.data[0].img.size,Actor:i.movieInfo.Actor,Director:i.movieInfo.Director,URL_ABS:i.maskParams.URL_ABS,MovieSize:i.movieInfo.MovieSize,Duration:i.maskParams.Duration,Score:i.movieInfo.Score,SearchName:i.movieInfo.SearchName,Year:i.movieInfo.Year,Price:i.movieInfo.Price,Introduce:i.movieInfo.Introduce,PicURL_ABS:i.uploadList.data[0].img.src},Category:i.catrgoryArr,Location:i.LocationArr});a({method:"POST",url:f.getApiUrl("movie","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(alert("编辑成功"),c.reload("app.editedList"),i.cancel()):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){i.saving=!1})}}]).controller("musicLiarbryController",["$http","$scope","$state","$filter","$stateParams","NgTableParams","util",function(a,b,c,d,e,f,g){console.log("musicLiarbryController");var h=this;h.init=function(){h.defaultLang=g.getDefaultLangCode(),h.getMusicList()},h.getMusicList=function(){h.loading=!0;var b=JSON.stringify({token:g.getParams("token"),action:"getMusicList"});a({method:"POST",url:g.getApiUrl("music","","server"),data:b}).then(function(a){var b=a.data;if("200"==b.rescode){if(console.log(b.musicList),0==b.musicList.length)return void(h.noData=!0);h.musicList=b.musicList}else"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.loading=!1})},h.delMusic=function(b){if(confirm("确定删除？")){var d=JSON.stringify({token:g.getParams("token"),action:"delMusic",lang:"zh-CN",ID:b,Item:"Music"});a({method:"POST",url:g.getApiUrl("music","","server"),data:d}).then(function(a){var b=a.data;"200"==b.rescode?(alert("删除成功"),c.reload(c.current.name)):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){})}},h.addMusic=function(){b.app.maskUrl="pages/addMusic.html"},h.editMusic=function(a){b.app.maskUrl="pages/editMusic.html",b.app.maskParams={music:a}}}]).controller("addMusicController",["$http","$scope","$state","$stateParams","util","CONFIG",function(a,b,c,d,e,f){function g(){this.data=[],this.maxId=0}console.log("addMusicController");var h=this;h.init=function(){h.editLangs=e.getParams("editLangs"),h.defaultLang=e.getDefaultLangCode(),h.maskParams=b.app.maskParams,h.movieInfo={},h.imgUploadList=new g,h.musicUploadList=new g},h.saveForm=function(){if(console.log(h.imgUploadList),console.log(h.musicUploadList),0==h.musicUploadList.data.length)return void alert("请上传音乐");if(0==h.imgUploadList.data.length)return void alert("请上传音乐图标");if(100!=h.imgUploadList.data[0].img.percentComplete||100!=h.musicUploadList.data[0].img.percentComplete)return void alert("上传中，请稍等");h.saving=!0;var b=JSON.stringify({token:e.getParams("token"),action:"addMusic",lang:"zh-CN",Music:{Seq:h.musicInfo.Seq,Name:h.musicInfo.Name,SingerName:h.musicInfo.SingerName,ColumnName:h.musicInfo.ColumnName,MusicIntro:h.musicInfo.MusicIntro,URL_ABS:h.musicUploadList.data[0].img.src,MusicSize:h.musicUploadList.data[0].img.size,PicURL_ABS:h.imgUploadList.data[0].img.src,PicSize:h.imgUploadList.data[0].img.size,Duration:h.musicInfo.Duration}});a({method:"POST",url:e.getApiUrl("music","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(alert("添加成功"),h.cancel(),c.reload("app.musicLibrary",d,{reload:!0})):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.saving=!1,h.cancel()})},h.cancel=function(){b.app.maskUrl=""},h.addCoverImg=function(){if(!b.myCoverImg)return void alert("请先选择图标");h.imgUploadList.uploadFile(b.myCoverImg,h.imgUploadList)},h.addMusic=function(){if(!b.myMusic)return void alert("请先选择音乐");h.musicUploadList.uploadFile(b.myMusic,h.musicUploadList)},g.prototype={add:function(a){return this.data.push({img:a,id:this.maxId}),this.maxId},changeImg:function(a){return this.data=[],this.data.push({img:a,id:this.maxId}),this.maxId},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].img.percentComplete<100&&"失败"!=b[c].img.percentComplete&&b[c].video.xhr.abort(),b.splice(c,1);break}},uploadFile:function(a,c){var d=f.uploadImgUrl,g=new XMLHttpRequest,i={name:a.name,size:a.size,percentComplete:0,xhr:g},j=this.changeImg(i);e.uploadFileToUrl(g,a,d,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);c.setPercentById("img",j,b)}})},function(a){var d=JSON.parse(a.responseText);console&&console.log(d),b.$apply(function(){c.setSrcSizeById("img",j,d.upload_path,d.size)}),h.movieInfo.PicSize=d.size},function(a){alert("图片上传失败，请重新上传"),c.deleteById(j),a.abort()})}}}]).controller("editMusicController",["$http","$scope","$state","$stateParams","util","CONFIG",function(a,b,c,d,e,f){function g(){this.data=[],this.maxId=0}console.log("editMusicController"),console.log(b.app.maskParams);var h=this;h.init=function(){h.editLangs=e.getParams("editLangs"),h.defaultLang=e.getDefaultLangCode(),h.musicInfo=b.app.maskParams.music,h.imgUploadList=new g,h.musicUploadList=new g,h.imgUploadList.data=[{img:{src:h.musicInfo.PicURL_ABS,size:h.musicInfo.PicSize}}],h.musicUploadList.data=[{img:{src:h.musicInfo.URL_ABS,size:h.musicInfo.MusicSize}}]},h.saveForm=function(){if(0==h.musicUploadList.data.length)return void alert("请上传音乐");if(0==h.imgUploadList.data.length)return void alert("请上传音乐图标");h.saving=!0;var b=JSON.stringify({token:e.getParams("token"),action:"addMusic",musicID:h.musicInfo.musicID,lang:"zh-CN",Music:{Seq:h.musicInfo.Seq,Name:h.musicInfo.Name,SingerName:h.musicInfo.SingerName,ColumnName:h.musicInfo.ColumnName,MusicIntro:h.musicInfo.MusicIntro,URL_ABS:h.musicUploadList.data[0].img.src,MusicSize:h.musicUploadList.data[0].img.size,PicURL_ABS:h.imgUploadList.data[0].img.src,PicSize:h.imgUploadList.data[0].img.size,Duration:h.musicInfo.Duration}});a({method:"POST",url:e.getApiUrl("music","","server"),data:b}).then(function(a){var b=a.data;"200"==b.rescode?(alert("保存成功"),h.cancel(),c.reload("app.musicLibrary",d,{reload:!0})):"401"==b.rescode?(alert("访问超时，请重新登录"),c.go("login")):alert(b.rescode+" "+b.errInfo)},function(a){alert(a.status+" 服务器出错")}).finally(function(a){h.saving=!1,h.cancel()})},h.cancel=function(){b.app.maskUrl=""},h.addCoverImg=function(){h.imgUploadList.uploadFile(b.myCoverImg,h.imgUploadList)},h.addMusic=function(){h.musicUploadList.uploadFile(b.myMusic,h.musicUploadList)},g.prototype={add:function(a){return this.data.push({img:a,id:this.maxId}),this.maxId},changeImg:function(a){return this.data=[],this.data.push({img:a,id:this.maxId}),this.maxId},setPercentById:function(a,b,c){for(var d=0;d<this.data.length;d++)if(this.data[d].id==b){this.data[d][a].percentComplete=c;break}},setSrcSizeById:function(a,b,c,d){for(var e=0;e<this.data.length;e++)if(this.data[e].id==b){this.data[e][a].src=c,this.data[e][a].size=d;break}},deleteById:function(a){for(var b=this.data,c=0;c<b.length;c++)if(b[c].id==a){b[c].img.percentComplete<100&&"失败"!=b[c].img.percentComplete&&b[c].video.xhr.abort(),b.splice(c,1);break}},uploadFile:function(a,c){var d=f.uploadImgUrl,g=new XMLHttpRequest,i={name:a.name,size:a.size,percentComplete:0,xhr:g},j=this.changeImg(i);e.uploadFileToUrl(g,a,d,"normal",function(a){b.$apply(function(){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);c.setPercentById("img",j,b)}})},function(a){var d=JSON.parse(a.responseText);console&&console.log(d),b.$apply(function(){c.setSrcSizeById("img",j,d.upload_path,d.size)}),h.movieInfo.PicSize=d.size,alert("上传成功")},function(a){alert("图片上传失败，请重新上传"),c.deleteById(j),a.abort()})}}}])}(),function(){angular.module("app.directives",[]).directive("fileModel",["$parse","CONFIG",function(a,b){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])}),"none"!=d.e&&document.getElementById(d.e).click()})}}}])}(),function(){angular.module("app.services",[]).factory("util",["$cookies","$translate","CONFIG",function(a,b,c){return{getApiUrl:function(a,b,d){return d?"server"==d?c.serverUrl+a:c.testUrl+b:c.test?c.testUrl+b:c.serverUrl+a},getUploadUrl:function(){return c.uploadUrl},setParams:function(b,c){a.put(b,JSON.stringify(c))},getParams:function(b){return!!a.get(b)&&JSON.parse(a.get(b))},langStyle:function(){return b.proposedLanguage()||b.use()},getDefaultLangCode:function(){if(a.get("editLangs"))for(var b=JSON.parse(a.get("editLangs")),c=0;c<b.length;c++)if(b[c].default)return b[c].code},uploadFileToUrl:function(a,b,c,d,e,f,g){var d=d?d:"normal",h=new FormData;h.append("action",d),h.append("file",b),a.open("POST",c,!0),a.upload.addEventListener("progress",function(a){e(a)},!1),a.onreadystatechange=function(b){4==a.readyState&&200==a.status&&""!=a.responseText?(console.log(JSON.parse(a.responseText)),0!==JSON.parse(a.responseText).result?g(a):f(a)):200!=a.status&&a.responseText&&g(a)},a.send(h)}}}])}(),function(){angular.module("app.filters",[]).filter("ajaxMethod",["CONFIG",function(a){return function(){return a.test?"GET":"POST"}}]).filter("fenToYuan",function(){return function(a){var b=a+"";return 1==b.length?b="00"+b:2==b.length&&(b="0"+b),b.slice(0,-2)+"."+b.slice(-2)}}).filter("subtitlePercentComplete",function(){return function(a){return a?"失败"==a?a:a+"%":"无"}})}();